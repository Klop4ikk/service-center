{% extends "layout.html" %}

{% block title %}Главная - Список заявок{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-list"></i> Список заявок</h1>
    
    <div class="page-actions">
        {% if g.user.type in ['Заказчик', 'Оператор', 'admin', 'Менеджер'] %}
        <a href="{{ url_for('create_request') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Новая заявка
        </a>
        {% endif %}
        
        <div class="quick-stats">
            <span class="stat-badge">
                <i class="fas fa-clipboard-list"></i>
                Всего: {{ requests|length }}
            </span>
            {% set completed = requests|selectattr('request_status', 'equalto', 'Готова к выдаче')|list %}
            <span class="stat-badge stat-completed">
                <i class="fas fa-check-circle"></i>
                Завершено: {{ completed|length }}
            </span>
            {% set in_progress = requests|selectattr('request_status', 'equalto', 'В процессе ремонта')|list %}
            <span class="stat-badge stat-progress">
                <i class="fas fa-wrench"></i>
                В работе: {{ in_progress|length }}
            </span>
        </div>
    </div>
</div>

{% if requests %}
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>№</th>
                <th>Дата создания</th>
                <th>Вид техники</th>
                <th>Модель</th>
                <th>Проблема</th>
                <th>Статус</th>
                <th>Клиент</th>
                <th>Мастер</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for request in requests %}
            <tr class="{% if request.request_status == 'Готова к выдаче' %}row-completed{% elif request.request_status == 'В процессе ремонта' %}row-progress{% elif request.request_status == 'Ожидание запчастей' %}row-waiting{% endif %}">
                <td class="text-center">
                    <strong>#{{ request.id }}</strong>
                </td>
                <td>{{ request.start_date }}</td>
                <td>{{ request.home_tech_type }}</td>
                <td>{{ request.home_tech_model }}</td>
                <td class="problem-cell">
                    <div class="problem-text">{{ request.problem_description[:80] }}{% if request.problem_description|length > 80 %}...{% endif %}</div>
                </td>
                <td>
                    <span class="status-badge status-{{ request.request_status|lower|replace(' ', '-') }}">
                        {% if request.request_status == 'Новая заявка' %}
                        <i class="fas fa-clock"></i>
                        {% elif request.request_status == 'В процессе ремонта' %}
                        <i class="fas fa-wrench"></i>
                        {% elif request.request_status == 'Ожидание запчастей' %}
                        <i class="fas fa-box-open"></i>
                        {% elif request.request_status == 'Готова к выдаче' %}
                        <i class="fas fa-check-circle"></i>
                        {% endif %}
                        {{ request.request_status }}
                    </span>
                </td>
                <td>
                    {% if g.user.type in ['Оператор', 'admin', 'Менеджер', 'Мастер'] %}
                    {{ request.client_fio }}
                    {% else %}
                    Моя заявка
                    {% endif %}
                </td>
                <td>
                    {% if request.master_fio %}
                    <span class="master-name">{{ request.master_fio }}</span>
                    {% else %}
                    <span class="text-muted">Не назначен</span>
                    {% endif %}
                </td>
                <td class="actions-cell">
                    <div class="action-buttons">
                        <a href="{{ url_for('request_detail', request_id=request.id) }}" 
                           class="btn btn-sm btn-view" title="Просмотр">
                            <i class="fas fa-eye"></i>
                        </a>
                        
                        {% if g.user.type in ['Оператор', 'admin', 'Менеджер'] or 
                              (g.user.type == 'Заказчик' and request.request_status == 'Новая заявка') or
                              (g.user.type == 'Мастер' and request.master_id == g.user.id) %}
                        <a href="{{ url_for('edit_request', request_id=request.id) }}" 
                           class="btn btn-sm btn-edit" title="Редактировать">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% endif %}
                        
                        {% if g.user.type in ['Оператор', 'admin', 'Менеджер', 'Менеджер по качеству'] and not request.master_id and request.request_status == 'Новая заявка' %}
                        <form method="POST" 
                              action="{{ url_for('assign_master', request_id=request.id) }}"
                              class="inline-form">
                            <button type="submit" 
                                    class="btn btn-sm btn-assign" 
                                    title="Назначить мастера">
                                <i class="fas fa-user-cog"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Фильтры заявок -->
<div class="filters">
    <h3><i class="fas fa-filter"></i> Фильтры</h3>
    <div class="filter-buttons">
        <a href="{{ url_for('index') }}" 
           class="filter-btn {% if not request.args.get('status') %}active{% endif %}">
            Все заявки
        </a>
        <a href="{{ url_for('index') }}?status=Новая заявка" 
           class="filter-btn status-new {% if request.args.get('status') == 'Новая заявка' %}active{% endif %}">
            Новые
        </a>
        <a href="{{ url_for('index') }}?status=В процессе ремонта" 
           class="filter-btn status-progress {% if request.args.get('status') == 'В процессе ремонта' %}active{% endif %}">
            В работе
        </a>
        <a href="{{ url_for('index') }}?status=Ожидание запчастей" 
           class="filter-btn status-waiting {% if request.args.get('status') == 'Ожидание запчастей' %}active{% endif %}">
            Ожидание запчастей
        </a>
        <a href="{{ url_for('index') }}?status=Готова к выдаче" 
           class="filter-btn status-completed {% if request.args.get('status') == 'Готова к выдаче' %}active{% endif %}">
            Завершённые
        </a>
    </div>
</div>

{% else %}
<div class="empty-state">
    <div class="empty-icon">
        <i class="fas fa-clipboard-list fa-4x"></i>
    </div>
    <h2>Заявок пока нет</h2>
    <p>Начните с создания первой заявки на ремонт</p>
    {% if g.user.type in ['Заказчик', 'Оператор', 'admin', 'Менеджер'] %}
    <a href="{{ url_for('create_request') }}" class="btn btn-primary btn-lg">
        <i class="fas fa-plus"></i> Создать первую заявку
    </a>
    {% endif %}
</div>
{% endif %}

<!-- Статистика для администраторов -->
{% if g.user.type in ['admin', 'Менеджер', 'Оператор'] %}
<div class="dashboard-stats">
    <h3><i class="fas fa-chart-pie"></i> Быстрая статистика</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tools"></i>
            </div>
            <div class="stat-content">
                <h4>Всего заявок</h4>
                <p class="stat-number">{{ requests|length }}</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-completed">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <h4>Выполнено</h4>
                <p class="stat-number">{{ completed|length }}</p>
                <p class="stat-percentage">
                    {% if requests|length > 0 %}
                    {{ ((completed|length / requests|length) * 100)|round(1) }}%
                    {% else %}0%{% endif %}
                </p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-progress">
                <i class="fas fa-wrench"></i>
            </div>
            <div class="stat-content">
                <h4>В работе</h4>
                <p class="stat-number">{{ in_progress|length }}</p>
                <p class="stat-percentage">
                    {% if requests|length > 0 %}
                    {{ ((in_progress|length / requests|length) * 100)|round(1) }}%
                    {% else %}0%{% endif %}
                </p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon stat-icon-new">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h4>Новые</h4>
                {% set new_requests = requests|selectattr('request_status', 'equalto', 'Новая заявка')|list %}
                <p class="stat-number">{{ new_requests|length }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}